{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8  bg-gray-100">
    <h1 class="text-xl font-bold mb-6 text-center">AML Screening </h1>

    <!-- Search Form -->
    <form
        id="searchForm"
        method="GET"
        action="{% url 'check_individual' %}"
        class="mx-auto relative mb-8 flex justify-center"
    >
        <!-- Container to center the row -->
        <div class="flex items-center w-[75%] border border-gray-300 rounded-full px-4 py-2 bg-white focus-within:border-blue-400 transition">
            <!-- SEARCH BAR -->
            <input
                id="search_query"
                type="text"
                name="query"
                placeholder="Search for a person or company..."
                class="w-full outline-none border border-gray-300 rounded-full bg-transparent text-sm px-2"
                value="{{ request.GET.query|default:'' }}"
                required
            />

            <!-- Hidden input to store the filter (source_type) -->
            <input
                type="hidden"
                name="source_type"
                id="sourceType"
                value="{{ request.GET.source_type|default:'ALL' }}"
            />

            <!-- Search Icon Button -->
            <button
                type="submit"
                class="text-gray-500 hover:text-blue-600 transition ml-2"
            >
                üîç
            </button>
        </div>

        <div class="flex items-center ">
            <!-- results.html snippet -->
            {% if results %}
            <p class="text-right">
              <a
                href="{% url 'download_report' %}?query={{ request.GET.query|urlencode }}&source_type={{ request.GET.source_type|default:'ALL'|urlencode }}"
                class="bg-gray-700 text-white px-4 py-2 rounded-md"
              >
                Download Report
              </a>
            </p>
            {% endif %} </div>
    </form>


 


    <!-- Filters -->
    <div class="flex justify-center gap-6 mb-6 text-sm font-medium text-gray-700">
        <a
            href="javascript:void(0)"
            data-filter="ALL"
            class="tab-link {% if request.GET.source_type == 'ALL' or not request.GET.source_type %}text-blue-600 border-b-2 border-blue-600{% endif %}"
        >
            ALL
        </a>
        <a
            href="javascript:void(0)"
            data-filter="SANCTION"
            class="tab-link {% if request.GET.source_type == 'SANCTION' %}text-blue-600 border-b-2 border-blue-600{% endif %}"
        >
            SANCTIONS
        </a>
        <a
            href="javascript:void(0)"
            data-filter="PEP"
            class="tab-link {% if request.GET.source_type == 'PEP' %}text-blue-600 border-b-2 border-blue-600{% endif %}"
        >
            PEPS
        </a>
        <a
            href="javascript:void(0)"
            data-filter="CRIMINAL"
            class="tab-link {% if request.GET.source_type == 'CRIMINAL' %}text-blue-600 border-b-2 border-blue-600{% endif %}"
        >
            CRIMINALS
        </a>
    </div>

    <!-- Results Display -->
    {% if results %}
    <div>
        <h2 class="text-xl font-bold mb-4">{{ results.total_hits }} records found</h2>
        {% for record in results.found_records %}
        <div class="bg-white shadow rounded-lg mb-4">
            <!-- Record Header (Collapsible Trigger) -->
            <div
                class="flex justify-between items-center p-4 cursor-pointer"
                onclick="toggleDetails('details-{{ forloop.counter }}')"
            >
                <div>
                    <h3 class="text-lg font-bold">{{ record.name }}</h3>
                    <p class="text-sm text-gray-500">Source ID: {{ record.source_id }}</p>
                </div>
                <div>
                    <span>‚ñº</span>
                </div>
            </div>
            <!-- Collapsible Details -->
            <div id="details-{{ forloop.counter }}" class="hidden p-4 border-t">
                <table class="table-auto w-full text-sm">
                    <tbody>
                        {% if record.source_type %}<tr><th class="font-bold py-1 px-2">Source Type:</th><td class="py-1 px-2">{{ record.source_type }}</td></tr>{% endif %}
                        {% if record.source_id %}<tr><th class="font-bold py-1 px-2">Source ID:</th><td class="py-1 px-2">{{ record.source_id }}</td></tr>{% endif %}
                        {% if record.id %}<tr><th class="font-bold py-1 px-2">Unique ID:</th><td class="py-1 px-2">{{ record.id }}</td></tr>{% endif %}
                        {% if record.entity_type %}<tr><th class="font-bold py-1 px-2">Entity Type:</th><td class="py-1 px-2">{{ record.entity_type }}</td></tr>{% endif %}
                        {% if record.list_date %}<tr><th class="font-bold py-1 px-2">List Date:</th><td class="py-1 px-2">{{ record.list_date }}</td></tr>{% endif %}
                        {% if record.gender %}<tr><th class="font-bold py-1 px-2">Gender:</th><td class="py-1 px-2">{{ record.gender }}</td></tr>{% endif %}
                        {% if record.tl_name %}<tr><th class="font-bold py-1 px-2">Transliterated Name:</th><td class="py-1 px-2">{{ record.tl_name }}</td></tr>{% endif %}
                        {% if record.alias_names %}<tr><th class="font-bold py-1 px-2">Alias Names:</th><td class="py-1 px-2">{{ record.alias_names|join:", " }}</td></tr>{% endif %}
                        {% if record.last_names %}<tr><th class="font-bold py-1 px-2">Last Names:</th><td class="py-1 px-2">{{ record.last_names|join:", " }}</td></tr>{% endif %}
                        {% if record.given_names %}<tr><th class="font-bold py-1 px-2">Given Names:</th><td class="py-1 px-2">{{ record.given_names|join:", " }}</td></tr>{% endif %}
                        {% if record.alias_given_names %}<tr><th class="font-bold py-1 px-2">Alias Given Names:</th><td class="py-1 px-2">{{ record.alias_given_names|join:", " }}</td></tr>{% endif %}
                        {% if record.name_remarks %}<tr><th class="font-bold py-1 px-2">Name Remarks:</th><td class="py-1 px-2">{{ record.name_remarks|join:", " }}</td></tr>{% endif %}
                        {% if record.spouse %}<tr><th class="font-bold py-1 px-2">Spouse:</th><td class="py-1 px-2">{{ record.spouse|join:", " }}</td></tr>{% endif %}
                        {% if record.parents %}<tr><th class="font-bold py-1 px-2">Parents:</th><td class="py-1 px-2">{{ record.parents|join:", " }}</td></tr>{% endif %}
                        {% if record.children %}<tr><th class="font-bold py-1 px-2">Children:</th><td class="py-1 px-2">{{ record.children|join:", " }}</td></tr>{% endif %}
                        {% if record.siblings %}<tr><th class="font-bold py-1 px-2">Siblings:</th><td class="py-1 px-2">{{ record.siblings|join:", " }}</td></tr>{% endif %}
                        {% if record.date_of_birth %}<tr><th class="font-bold py-1 px-2">Date of Birth:</th><td class="py-1 px-2">{{ record.date_of_birth|join:", " }}</td></tr>{% endif %}
                        {% if record.date_of_birth_remarks %}<tr><th class="font-bold py-1 px-2">DOB Remarks:</th><td class="py-1 px-2">{{ record.date_of_birth_remarks|join:", " }}</td></tr>{% endif %}
                        {% if record.place_of_birth %}<tr><th class="font-bold py-1 px-2">Place of Birth:</th><td class="py-1 px-2">{{ record.place_of_birth|join:", " }}</td></tr>{% endif %}
                        {% if record.place_of_birth_remarks %}<tr><th class="font-bold py-1 px-2">Place of Birth Remarks:</th><td class="py-1 px-2">{{ record.place_of_birth_remarks|join:", " }}</td></tr>{% endif %}
                        {% if record.address %}<tr><th class="font-bold py-1 px-2">Address:</th><td class="py-1 px-2">{{ record.address|join:"<br>"|safe }}</td></tr>{% endif %}
                        {% if record.address_remarks %}<tr><th class="font-bold py-1 px-2">Address Remarks:</th><td class="py-1 px-2">{{ record.address_remarks|join:", " }}</td></tr>{% endif %}
                        {% if record.citizenship %}<tr><th class="font-bold py-1 px-2">Citizenship:</th><td class="py-1 px-2">{{ record.citizenship|join:", " }}</td></tr>{% endif %}
                        {% if record.citizenship_remarks %}<tr><th class="font-bold py-1 px-2">Citizenship Remarks:</th><td class="py-1 px-2">{{ record.citizenship_remarks|join:", " }}</td></tr>{% endif %}
                        {% if record.sanction_details %}<tr><th class="font-bold py-1 px-2">Sanction Details:</th><td class="py-1 px-2">{{ record.sanction_details|join:", " }}</td></tr>{% endif %}
                        {% if record.description %}<tr><th class="font-bold py-1 px-2">Description:</th><td class="py-1 px-2">{{ record.description|join:", " }}</td></tr>{% endif %}
                        {% if record.occupations %}<tr><th class="font-bold py-1 px-2">Occupations:</th><td class="py-1 px-2">{{ record.occupations|join:", " }}</td></tr>{% endif %}
                        {% if record.positions %}<tr><th class="font-bold py-1 px-2">Positions:</th><td class="py-1 px-2">{{ record.positions|join:", " }}</td></tr>{% endif %}
                        {% if record.political_parties %}<tr><th class="font-bold py-1 px-2">Political Parties:</th><td class="py-1 px-2">{{ record.political_parties|join:", " }}</td></tr>{% endif %}
                        {% if record.links %}
                        <tr>
                            <th class="font-bold py-1 px-2">Links:</th>
                            <td class="py-1 px-2">
                                {% for link in record.links %}
                                    <a href="{{ link }}" target="_blank" class="text-blue-500 underline">{{ link }}</a><br>
                                {% endfor %}
                            </td>
                        </tr>
                        {% endif %}
                        {% if record.titles %}<tr><th class="font-bold py-1 px-2">Titles:</th><td class="py-1 px-2">{{ record.titles|join:", " }}</td></tr>{% endif %}
                        {% if record.functions %}<tr><th class="font-bold py-1 px-2">Functions:</th><td class="py-1 px-2">{{ record.functions|join:", " }}</td></tr>{% endif %}
                        {% if record.other_information %}<tr><th class="font-bold py-1 px-2">Other Info:</th><td class="py-1 px-2">{{ record.other_information|join:", " }}</td></tr>{% endif %}
                        {% if record.source_country %}<tr><th class="font-bold py-1 px-2">Source Country:</th><td class="py-1 px-2">{{ record.source_country }}</td></tr>{% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-center text-red-500">No results found.</p>
    {% endif %}

    {% if error %}
    <div class="text-red-500 text-center mt-4">{{ error }}</div>
    {% endif %}
</div>

<script>
    // Collapse toggler
    function toggleDetails(id) {
        var element = document.getElementById(id);
        if (element.classList.contains('hidden')) {
            element.classList.remove('hidden');
        } else {
            element.classList.add('hidden');
        }
    }

    // Automatic form submission when user clicks filters
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('searchForm');
        const sourceTypeInput = document.getElementById('sourceType');
        const searchQuery = document.getElementById('search_query');

        document.querySelectorAll('.tab-link').forEach(link => {
            link.addEventListener('click', function() {
                sourceTypeInput.value = this.getAttribute('data-filter');
                if (searchQuery.value.trim() !== '') {
                    // re-submit the form
                    form.submit();
                }
            });
        });
    });
</script>
{% endblock %}
