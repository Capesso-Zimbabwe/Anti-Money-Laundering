{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="flex flex-col items-center min-h-screen bg-gray-100 p-6">
    <div class="w-full max-w-6xl">

        <!-- Top Row: Title & Date Range -->
        <div class="flex items-center justify-between mb-4 w-full">
            <h2 class="text-lg font-bold text-gray-800">
                Batch KYC Screening
            </h2>

            <!-- Date range inputs + "Run KYC" button -->
            <div class="flex items-center space-x-3">
                <label class="text-sm font-semibold" for="startDate">Start Date:</label>
                <input
                    type="date"
                    id="startDate"
                    class="border rounded px-2 py-1 text-sm"
                    value="{{ request.GET.start_date|default:'' }}"
                />
                <label class="text-sm font-semibold" for="endDate">End Date:</label>
                <input
                    type="date"
                    id="endDate"
                    class="border rounded px-2 py-1 text-sm"
                    value="{{ request.GET.end_date|default:'' }}"
                />
                <button
                    id="runScreening"
                    class="px-4 py-2 bg-[#f68430] text-white  text-sm font-semibold rounded-lg hover:bg-orange-300 transition"
                >
                    Run
                </button>
            </div>
        </div>

        <!-- Loader (Hidden initially) -->
        <div id="loader" class="hidden flex justify-center mt-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-4 border-blue-600"></div>
            <p class="ml-2 text-gray-700">Running KYC...</p>
        </div>

        <!-- Results Display (Status & Count) -->
        <div id="results" class="hidden bg-white shadow-md rounded-lg p-6 mt-6 text-center">
            <p class="text-lg font-semibold text-gray-700">
                <span id="status" class="font-bold text-blue-600"></span>
            </p>
            <p class="text-lg font-semibold text-gray-700">
                <span id="count" class="font-bold text-green-600"></span>
            </p>
        </div>

        <!-- KYC Test Results Table (Shown if show_table=1) -->
        {% if show_table %}
        <div class="bg-white shadow-md rounded-lg p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">
                KYC Test Results 
            </h3>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700">
                            <th class="p-3 border border-gray-300">Customer Name</th>
                            <th class="p-3 border border-gray-300">ID Document</th>
                            <th class="p-3 border border-gray-300">Risk Level</th>
                            <th class="p-3 border border-gray-300">KYC Status</th>
                            <th class="p-3 border border-gray-300">Reviewer</th>
                            <th class="p-3 border border-gray-300">Verification Notes</th>
                            <th class="p-3 border border-gray-300">Created At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sprofile in page_obj %}
                        <tr class="border border-gray-300 text-gray-700 hover:bg-gray-100">
                            <td class="p-3 border border-gray-300">
                                {{ sprofile.full_name }}
                            </td>
                            <td class="p-3 border border-gray-300">
                                {{ sprofile.id_document_number }}
                            </td>
                            <td
                                class="p-3 border border-gray-300 {% if sprofile.risk_level == 'High' %}text-red-500{% elif sprofile.risk_level == 'Medium' %}text-yellow-500{% else %}text-green-500{% endif %} font-bold"
                            >
                                {{ sprofile.risk_level }}
                            </td>
                            <td class="p-3 border border-gray-300">
                                {{ sprofile.kyc_status }}
                            </td>
                            <td class="p-3 border border-gray-300">
                                {{ sprofile.reviewer|default:"N/A" }}
                            </td>
                            <td class="p-3 border border-gray-300">
                                {{ sprofile.verification_notes|default:"No notes" }}
                            </td>
                            <td class="p-3 border border-gray-300">
                                {{ sprofile.created_at|date:"Y-m-d H:i" }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center text-gray-500 p-4">
                                No KYC Test Results found for this date range.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="mt-4 flex justify-between items-center">
                {% if page_obj.has_previous %}
                    <a
                        href="?page=1&show_table=1&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}"
                        class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400"
                    >
                        First
                    </a>
                    <a
                        href="?page={{ page_obj.previous_page_number }}&show_table=1&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}"
                        class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400"
                    >
                        Previous
                    </a>
                {% endif %}

                <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

                {% if page_obj.has_next %}
                    <a
                        href="?page={{ page_obj.next_page_number }}&show_table=1&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}"
                        class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400"
                    >
                        Next
                    </a>
                    <a
                        href="?page={{ page_obj.paginator.num_pages }}&show_table=1&start_date={{ request.GET.start_date }}&end_date={{ request.GET.end_date }}"
                        class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400"
                    >
                        Last
                    </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const runBtn = document.getElementById("runScreening");
        const loader = document.getElementById("loader");
        const resultsDiv = document.getElementById("results");
        const statusEl = document.getElementById("status");
        const countEl = document.getElementById("count");

        runBtn.addEventListener("click", function () {
            loader.classList.remove("hidden");
            resultsDiv.classList.add("hidden");

            // Gather the date range from the two <input type="date"> fields
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;

            fetch("{% url 'run_kyc_aml_screening' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    start_date: startDate,
                    end_date: endDate
                })
            })
            .then(response => response.json())
            .then(data => {
                loader.classList.add("hidden");
                resultsDiv.classList.remove("hidden");

                // Display the response
                statusEl.textContent = data.status || "Screening finished";
                countEl.textContent = data.profiles_checked || "0";

                // Auto-redirect to show table, including start/end date in URL
                const urlParams = new URLSearchParams();
                urlParams.append("show_table", "1");
                if (startDate) urlParams.append("start_date", startDate);
                if (endDate) urlParams.append("end_date", endDate);

                window.location.search = urlParams.toString();
            })
            .catch(error => {
                loader.classList.add("hidden");
                alert("Error running KYC screening.");
                console.error(error);
            });
        });
    });
</script>
{% endblock %}
