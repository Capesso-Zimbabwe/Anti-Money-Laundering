{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="space-y-8">
  <!-- Page Header -->
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Risk Definitions</h1>
      <p class="text-gray-500">Reference table for Country and Source of Funds risk scores</p>
    </div>
    <button onclick="openRiskDefinitionModal()" class="px-4 py-2 bg-[#f68430] text-white rounded-lg hover:bg-orange-300 flex items-center gap-2 shadow-sm transition-all duration-200">
      <!-- SVG icon omitted for brevity -->
      New Risk Definition
    </button>
  </div>

  <!-- Page Size Selector Form -->
  <form id="pageSizeForm" method="GET" class="flex items-center gap-2">
    <label for="page_size" class="text-sm text-gray-700">Items per page:</label>
    <select name="page_size" id="page_size" onchange="this.form.submit()" class="rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
      <option value="5" {% if page_size == 5 %}selected{% endif %}>5</option>
      <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
      <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
    </select>
  </form>

  <!-- Risk Definition Modal -->
  <div id="riskDefinitionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-medium text-gray-900">New Risk Definition</h3>
        <button onclick="closeRiskDefinitionModal()" class="text-gray-400 hover:text-gray-500">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <form method="post" action="{% url 'risk_definitions' %}" class="space-y-4">
        {% csrf_token %}
        <!-- Category Selector -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Category</label>
          <select id="riskCategory" name="category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            <option value="country" selected>Country</option>
            <option value="source">Source of Funds</option>
          </select>
        </div>
        <!-- Country Dropdown (populated dynamically) -->
        <div id="countryValueDiv">
          <label class="block text-sm font-medium text-gray-700">Country</label>
          <select id="countrySelect" name="value" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            <option value="" disabled selected>Select a country</option>
          </select>
        </div>
        <!-- Source of Funds Dropdown (predefined options) -->
        <div id="sourceValueDiv" class="hidden">
          <label class="block text-sm font-medium text-gray-700">Source of Funds</label>
          <select id="sourceSelect" name="value" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
            <option value="" disabled selected>Select a source</option>
            <option value="salary">Salary</option>
            <option value="business">Business Income</option>
            <option value="investment">Investments</option>
            <option value="inheritance">Inheritance</option>
            <option value="other">Other</option>
          </select>
        </div>
        <!-- Risk Rating as Percentage -->
        <div>
          <label class="block text-sm font-medium text-gray-700">Risk Rating (%)</label>
          <input type="number" name="risk_rating" min="0" max="100" step="0.01" value="50.00" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
        </div>
        <div class="flex justify-end space-x-3 mt-6">
          <button type="button" onclick="closeRiskDefinitionModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Country Risk Definitions Section -->
  <div>
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Country Risk Definitions</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for definition in country_page_obj %}
      <div class="bg-blue-50 border border-blue-100 rounded-xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">{{ definition.value }}</h3>
          <span class="px-3 py-1 text-sm font-medium bg-blue-100 text-blue-700 rounded-full">
            {{ definition.risk_rating }}% ({{ definition.risk_category }})
          </span>
        </div>
      </div>
      {% empty %}
      <div class="col-span-full text-center py-8">
        <p class="text-gray-500">No country risk definitions found.</p>
      </div>
      {% endfor %}
    </div>
    <!-- Country Risk Metrics Summary -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mt-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Country Risk Assessment Metrics</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Total High Risk</span>
            <span class="text-sm font-medium text-red-600">{{ country_high }}</span>
          </div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Total Medium Risk</span>
            <span class="text-sm font-medium text-yellow-600">{{ country_medium }}</span>
          </div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Total Low Risk</span>
            <span class="text-sm font-medium text-green-600">{{ country_low }}</span>
          </div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Total Assessments</span>
            <span class="text-sm font-medium text-blue-600">{{ country_total }}</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Pagination for Country Definitions -->
    <div class="mt-4 flex justify-center">
      {% if country_page_obj.has_previous %}
        <a href="?page_size={{ page_size }}&country_page={{ country_page_obj.previous_page_number }}" class="px-3 py-1 border rounded-l-md">Previous</a>
      {% endif %}
      <span class="px-3 py-1 border-t border-b">{{ country_page_obj.number }} of {{ country_page_obj.paginator.num_pages }}</span>
      {% if country_page_obj.has_next %}
        <a href="?page_size={{ page_size }}&country_page={{ country_page_obj.next_page_number }}" class="px-3 py-1 border rounded-r-md">Next</a>
      {% endif %}
    </div>
  </div>

  <!-- Source of Funds Risk Definitions Section -->
  <div>
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Source of Funds Risk Definitions</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {% for definition in source_page_obj %}
      <div class="bg-purple-50 border border-purple-100 rounded-xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-900">{{ definition.value }}</h3>
          <span class="px-3 py-1 text-sm font-medium bg-purple-100 text-purple-700 rounded-full">
            {{ definition.risk_rating }}% ({{ definition.risk_category }})
          </span>
        </div>
      </div>
      {% empty %}
      <div class="col-span-full text-center py-8">
        <p class="text-gray-500">No source of funds risk definitions found.</p>
      </div>
      {% endfor %}
    </div>
    <!-- Source of Funds Risk Metrics Summary -->
    <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 mt-6">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Source of Funds Risk Assessment Metrics</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Total High Risk</span>
            <span class="text-sm font-medium text-red-600">{{ source_high }}</span>
          </div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Total Medium Risk</span>
            <span class="text-sm font-medium text-yellow-600">{{ source_medium }}</span>
          </div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Total Low Risk</span>
            <span class="text-sm font-medium text-green-600">{{ source_low }}</span>
          </div>
        </div>
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-600">Total Assessments</span>
            <span class="text-sm font-medium text-blue-600">{{ source_total }}</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Pagination for Source Definitions -->
    <div class="mt-4 flex justify-center">
      {% if source_page_obj.has_previous %}
        <a href="?page_size={{ page_size }}&source_page={{ source_page_obj.previous_page_number }}" class="px-3 py-1 border rounded-l-md">Previous</a>
      {% endif %}
      <span class="px-3 py-1 border-t border-b">{{ source_page_obj.number }} of {{ source_page_obj.paginator.num_pages }}</span>
      {% if source_page_obj.has_next %}
        <a href="?page_size={{ page_size }}&source_page={{ source_page_obj.next_page_number }}" class="px-3 py-1 border rounded-r-md">Next</a>
      {% endif %}
    </div>
  </div>
</div>

{% block extra_js %}
<script>
  // Populate the country dropdown using the REST Countries API
  async function fetchCountries() {
    try {
      const response = await fetch("https://restcountries.com/v3.1/all");
      const countries = await response.json();
      countries.sort((a, b) => a.name.common.localeCompare(b.name.common));
      const countrySelect = document.getElementById("countrySelect");
      countrySelect.innerHTML = '<option value="" disabled selected>Select a country</option>';
      countries.forEach(country => {
        const option = document.createElement("option");
        option.value = country.name.common;
        option.textContent = country.name.common;
        countrySelect.appendChild(option);
      });
    } catch (error) {
      console.error("Error fetching countries:", error);
    }
  }

  // Toggle the Value input based on the selected category
  function toggleValueField() {
    const category = document.getElementById("riskCategory").value;
    const countryDiv = document.getElementById("countryValueDiv");
    const sourceDiv = document.getElementById("sourceValueDiv");
    if (category === "country") {
      countryDiv.classList.remove("hidden");
      countryDiv.querySelector("select").setAttribute("required", "required");
      sourceDiv.classList.add("hidden");
      sourceDiv.querySelector("select").removeAttribute("required");
    } else if (category === "source") {
      sourceDiv.classList.remove("hidden");
      sourceDiv.querySelector("select").setAttribute("required", "required");
      countryDiv.classList.add("hidden");
      countryDiv.querySelector("select").removeAttribute("required");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    toggleValueField();
    fetchCountries();
    document.getElementById("riskCategory").addEventListener("change", toggleValueField);
  });

  function openRiskDefinitionModal() {
    document.getElementById('riskDefinitionModal').classList.remove('hidden');
  }
  function closeRiskDefinitionModal() {
    document.getElementById('riskDefinitionModal').classList.add('hidden');
  }
  window.onclick = function(event) {
    const modal = document.getElementById('riskDefinitionModal');
    if (event.target == modal) {
      closeRiskDefinitionModal();
    }
  }
</script>
{% endblock %}
{% endblock %}
